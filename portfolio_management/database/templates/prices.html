{% extends "layout.html" %}
{% load static %}

{% block title %}Portfolio Data{% endblock title %}

{% block main_page_title %}
<h2>Database â€“ Prices</h2>
{% endblock main_page_title %}

{% block content %}
    <div class="container-fluid">
        <div class="row mb-3">
            <div class="col-md-3">
                <label for="start_date">Start Date:</label>
                <input type="date" id="start_date" class="form-control">
            </div>
            <div class="col-md-3">
                <label for="end_date">End Date:</label>
                <input type="date" id="end_date" class="form-control">
            </div>
            <div class="col-md-3">
                <label for="asset_types">Asset Types:</label>
                <select id="asset_types" class="form-control selectpicker" multiple data-live-search="true">
                    {% for key, value in asset_types.items %}
                        <option value="{{ key }}">{{ value }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="securities">Securities:</label>
                <select id="securities" class="form-control selectpicker" multiple data-live-search="true">
                    {% for security in securities %}
                        <option value="{{ security.id }}">{{ security.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <button id="apply_filters" class="btn btn-primary mb-3">Apply Filters</button>
        
        <table id="price_data_table" class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Security</th>
                    <th>Asset Type</th>
                    <th>Currency</th>
                    <th>Price</th>
                    {% comment %} <th>USD Price</th>
                    <th>FX Rate</th> {% endcomment %}
                    <th>Actions</th>
                </tr>
            </thead>
        </table>
    </div>

    <!-- Edit Price Modal Placeholder -->
    <div id="editPriceModalContainer"></div>
{% endblock content %}

{% block script %}
    <script>
        $(document).ready(function() {
            $('.selectpicker').selectpicker();

            var table = $('#price_data_table').DataTable({
                ajax: {
                    url: "{% url 'database:get_price_data_for_table' %}",
                    data: function(d) {
                        d.start_date = $('#start_date').val();
                        d.end_date = $('#end_date').val();
                        d.asset_types = $('#asset_types').val();
                        d.securities = $('#securities').val();
                    }
                },
                columns: [
                    {data: 'date'},
                    {data: 'security'},
                    {data: 'asset_type'},
                    {data: 'currency'},
                    {data: 'price', render: function(data, type, row) {
                        if (type === 'display') {
                            return '<span class="editable" data-id="' + row.id + '">' + data.toFixed(2) + '</span>';
                        }
                        return data;
                    }},
                    {% comment %} {data: 'usd_price', render: function(data, type, row) {
                        return data.toFixed(2);
                    }},
                    {data: 'fx_rate', render: function(data, type, row) {
                        return data.toFixed(4);
                    }}, {% endcomment %}
                    {data: null, render: function(data, type, row) {
                        return '<button class="btn btn-sm btn-primary edit-btn" data-id="' + row.id + '">Edit</button>';
                    }}
                ]
            });

            $('#apply_filters').click(function() {
                table.ajax.reload();
            });

            $('#price_data_table').on('click', '.edit-btn', function() {
                var id = $(this).data('id');
                console.log('Edit button clicked for id:', id);
                $.ajax({
                    url: "{% url 'database:edit_price' 0 %}".replace('0', id),
                    type: 'GET',
                    success: function(response) {
                        console.log('AJAX request successful');
                        $('#editPriceModalContainer').html(response.form_html);
                        console.log('Modal content updated');
                        $('#editPriceModal').modal('show');
                        console.log('Modal show triggered');
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX request failed:', status, error);
                        alert('Error loading edit form');
                    }
                });
            });
        
            $(document).on('submit', '#editPriceModal form', function(e) {
                e.preventDefault();
                var form = $(this);
                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: form.serialize(),
                    success: function(response) {
                        if (response.success) {
                            $('#editPriceModal').modal('hide');
                            table.ajax.reload();
                        } else {
                            // Display errors
                            for (var field in response.errors) {
                                $('#' + field + '_error').text(response.errors[field]);
                            }
                        }
                    },
                    error: function() {
                        alert('Error updating price');
                    }
                });
            });

        });
    </script>
{% endblock script %}